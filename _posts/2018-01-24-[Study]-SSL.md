# [공부] SSL

## 블로그1

SSL은 서버 인증, 클라이언트 인증, 데이터 암호화 기능을 제공한다.

인증은 통신의 상대방이 맞는지 확인하는 절차를 의미한다.

SSL은 이제 TLS(Transport Layer Security)라고 이름이 바뀌었다. IETF(Internet Engineering Task Force)에서 표준을 유지 관리하고 있다. 하지만 아직 SSL이라고 부른다.

공개키 암호화 방식을 사용한다. 공개키 암호화는 공개키와 비밀키의 조합에 근거한다. 이름에서 알 수 있듯이 공개키는 아무에게나 공개할 수 있지만 비밀키는 안 된다.

인증서는 소유자의 공개키가 맞는지 검증하는 도구다.

- 공개키를 소유하고 있는 자의 이름
- 공개키를 발급한 자의 이름
- 인증서의 유효기간
- 공개키

인증서는 인증 기관을 통해 발급받을 수도 있고, 직접 만들 수도 있다. 직접 만든 인증서를 자기-서명 인증서라고 한다. 인증 기관들 사이에는 계층이 있고, 최상위 루트 CA는 자기-서명 인증서를 가지고 있다. 자신을 인증해줄 더 높은 인증 기관이 없기 때문에 당연하다. 하부 CA들은 직속 상관이 발급한 인증서를 가지고 있다.

특정 CA는 최상위 CA부터 자신까지 내려오는 계층의 각 CA들의 인증서 묶음을 가지게 되는데 이를 인증서 체인이라고 한다.

## 생활코딩 > 서버 > 인프라 > 인터넷 > HTTPS와 SSL 인증서

### 대칭키

동일한 키로 암호화와 복호화를 할 수 있는 암호화 기법

```bash
# 암호화하기
openssl enc -e -des3 -salt -in plaintext.txt -out ciphertext.bin;
# 복호화하기
openssl enc -d -des3 -in ciphertext.bin -out plaintext2.txt;
```

### 공개키

A키로 암호화하면 B키로 복호화할 수 있고, B키로 암호화하면 A키로 복호화할 수 있는 방식

두개의 키 중 하나를 공개키(public key), 다른 하나를 비공개키(private key)라고 한다.

> 본문 중 이해가 잘 가지 않아서 여러 번 다시 읽은 부분
>
> 이 방식은 이렇게 응용할 수도 있다. 비공개키의 소유자는 비공개키를 이용해서 정보를 암호화 한 후에 공개키와 함께 암호화된 정보를 전송한다. 정보와 공개키를 획득한 사람은 공개키를 이용해서 암호화된 정보를 복호화 한다. 이 과정에서 공개키가 유출된다면 의도하지 않은 공격자에 의해서 데이터가 복호화 될 위험이 있다. 이런 위험에도 불구하고 비공개키를 이용해서 암호화를 하는 이유는 무엇일까? 그것은 이것이 데이터를 보호하는 것이 목적이 아니기 때문이다. 암호화된 데이터를 공개키를 가지고 복호화 할 수 있다는 것은 그 데이터가 공개키와 쌍을 이루는 비공개키에 의해서 암호화 되었다는 것을 의미한다. 즉 공개키가 데이터를 제공한 사람의 신원을 보장해주게 되는 것이다. 이러한 것을 전자 서명이라고 부른다.

#### 전자 서명

문서가 공개키로 복호화될 경우, 이 문서는 비공개키에 의해 암호화되었다는 것을 의미한다. 즉, 공개키를 이용해서 암호화한 데이터 제공자의 신원을 보장할 수 있다. 이러한 것을 전자 서명이라고 부른다.

>  공개된 키를 통해 복호화할 수 있으므로 이 암호화의 목적은 데이터 보호가 아니라 데이터 제공자 인증이다.

```bash
# 비밀키 생성
openssl genrsa -out private.pem 1024;
# 비밀키를 이용해 공개키 생성
openssl rsa -in private.pem -out public.pem -outform PEM -pubout;
# 예제 파일 생성
echo 'coding everybody' > file.txt;
# 공개키를 이용해 암호화
openssl rsautl -encrypt -inkey public.pem -pubin -in file.txt -out file.ssl;
# 비공개키를 이용해 복호화
openssl rsautl -decrypt -inkey private.pem -in file.ssl -out decrypted.txt;
```

공개키는 매우 어려운 문제, 비밀키는 어려운 문제를 풀기 위한 특별한 종류의 정보라고 생각할 수 있다.

예를 들면 아주 큰 두 소수를 비밀키로, 두 소수의 곱을 공개키로 설정할 수 있다.

### SSL 인증서

SSL 인증서의 기능은 크게 두 가지다.

1. 클라이언트가 접속한 서버의 신뢰도 보장
2. 클아이언트에게 공개키 제공

#### CA (Certificate Authority)

클라이언트가 접속한 서버를 인증해주는 역할. 몇몇 공인된 기업들이 제공한다. SSL을 통해서 암호화된 통신을 하려면 CA를 통해서 인증서를 구입해야 한다.

#### 인증서에 포함된 내용

1. 서비스 정보
2. 공개키와 관련 내용

인증서의 내용은 CA가 가진 비공개키에 의해 암호화된다. 브라우저는 공개키를 통해 CA를 확인한다. 당연히 브라우저들은 CA들의 공개키 목록을 가지고 있다.

브라우저는 이렇게 복호화한 인증서 내용을 통해 클라이언트가 접속한 사이트의 신뢰도를 판단한다.

### SSL 동작 방법

악수 - 세션 - 세션 종료 단계로 나누어 설명한다.

#### 악수

SSL 인증서를 주고 받는다. 공개키 방식은 컴퓨터 자원을 많이 소모하므로, 데이터의 경우 대칭키 방식을 사용한다.

1. Client Hello: 클라이언트가 생성한 랜덤 데이터, 지원하는 암호화 방식들, 세션 아이디
2. Server Hello: 서버가 생성한 랜덤 데이터, 선택한 암호화 방식, 인증서
3. 클라이언트는 인증서를 통해 CA 인증을 마친 후 클라이언트와 서버의 랜덤 데이터를 조합해서 pre master secret 키를 생성해서 데이터 암호화 대칭키로 사용한다. 이 키는 인증서에서 얻은 CA의 공개키를 이용해 암호화해서 CA에게 전달한다.
4. 서버는 자신의 비공개키로 복호화해서 pre master secret 키 값을 얻는다.
5. 악수 단계가 종료됨을 서로에게 알린다.

#### 세션

데이터를 실제로 주고 받는 단계다. 서버와 클라이언트 모두 일련의 과정을 거쳐 pre master secret 값을 master secret 값으로 만든다. master secret은 session key를 생성하고, 이 session key 값을 이용해서 데이터를 대칭키 방식으로 암호화하여 주고 받는다.

#### 세션 종료

SSL 통신이 끝났음을 서로에게 알려주고 세션키를 폐기한다.